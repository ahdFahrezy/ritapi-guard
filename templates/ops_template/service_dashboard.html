{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">
                        <i class="fas fa-server mr-2"></i>
                        Service Management Dashboard
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary" onclick="openAddServiceModal()">
                            <i class="fas fa-plus"></i> Add Service
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Statistics Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Total Services</h5>
                                    <p class="card-text">{{ total_services }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Active Services</h5>
                                    <p class="card-text">{{ total_services }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Total Requests</h5>
                                    <p class="card-text">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Blocked Requests</h5>
                                    <p class="card-text">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Search and Filter -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchInput" placeholder="Search services by URL...">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" onclick="searchServices()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 text-right">
                            <span class="text-white">
                                {% if page_obj %}
                                    Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} services
                                {% else %}
                                    Showing {{ services|length }} services
                                {% endif %}
                            </span>
                        </div>
                    </div>

                    <!-- Services Table -->
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th width="15%">UUID</th>
                                    <th width="35%">Target Backend URL</th>
                                    <th width="15%">Created</th>
                                    <th width="10%">Status</th>
                                    <th width="25%">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for service in services %}
                                <tr>
                                    <td>
                                        <code class="text-sm">{{ service.uuid }}</code>
                                        <button class="btn btn-sm btn-outline-secondary ml-2" 
                                                onclick="copyToClipboard('{{ service.uuid }}')"
                                                title="Copy UUID">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <a href="{{ service.target_base_url }}" target="_blank" class="text-primary">
                                            {{ service.target_base_url }}
                                        </a>
                                        <button class="btn btn-sm btn-outline-secondary ml-2" 
                                                onclick="copyToClipboard('{{ service.target_base_url }}')"
                                                title="Copy URL">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </td>
                                    <td>{{ service.timestamp|date:"M d, Y H:i" }}</td>
                                    <td>
                                        <span class="badge bg-success">Active</span>
                                    </td>
                                    <td>
                                        <a href="{% url 'ops_services:service_detail' service.uuid %}" 
                                           class="btn btn-sm btn-primary" 
                                           title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="btn btn-sm btn-info" 
                                                onclick="editService('{{ service.uuid }}', '{{ service.target_base_url }}')"
                                                title="Edit Service">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" 
                                                onclick="deleteService('{{ service.uuid }}', '{{ service.target_base_url }}')"
                                                title="Delete Service">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-3x mb-3"></i>
                                        <h5>No services found</h5>
                                        <p>Create your first service to get started with WAF routing.</p>
                                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addServiceModal">
                                            <i class="fas fa-plus"></i> Add First Service
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if page_obj and page_obj.has_other_pages %}
                    <nav aria-label="Service pagination" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1">&laquo; First</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">&laquo; First</span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link">Previous</span>
                                </li>
                            {% endif %}

                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last &raquo;</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">Next</span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link">Last &raquo;</span>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Service Modal -->
<div class="modal fade" id="addServiceModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Service</h5>
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal" onclick="closeAddServiceModal()">
                    <span>&times;</span>
                </button>
            </div>
            <form id="addServiceForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="targetUrl">Target Backend URL</label>
                        <input type="url" class="form-control" id="targetUrl" 
                               placeholder="https://api.example.com" required>
                        <small class="form-text text-muted">
                            The base URL of the backend service that this WAF will route to.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeAddServiceModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Service</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Service Modal -->
<div class="modal fade" id="editServiceModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Service</h5>
                <button type="button" class="close" data-bs-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="editServiceForm">
                {% csrf_token %}
                <input type="hidden" id="editServiceUuid">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editTargetUrl">Target Backend URL</label>
                        <input type="url" class="form-control" id="editTargetUrl" 
                               placeholder="https://api.example.com" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Service</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteServiceModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="close" data-bs-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> This action cannot be undone!
                </div>
                <p>Are you sure you want to delete this service?</p>
                <p><strong>Service UUID:</strong> <span id="deleteServiceUuid"></span></p>
                <p><strong>Target URL:</strong> <span id="deleteServiceUrl"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete Service</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentServiceUuid = null;

// Copy UUID to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        showToast('Copied to clipboard!', 'success');
    }, function(err) {
        console.error('Could not copy text: ', err);
        showToast('Failed to copy', 'error');
    });
}

// Show toast notification
function showToast(message, type = 'info') {
    // You can implement your own toast notification here
    alert(message);
}

// Reset form and modal
function resetModal(modalId) {
    const modal = $(modalId);
    modal.find('form')[0].reset();
    modal.find('.alert').remove();
    modal.find('.is-invalid').removeClass('is-invalid');
}

// Show error in modal
function showModalError(modalId, message) {
    const modal = $(modalId);
    const alertHtml = `<div class="alert alert-danger">${message}</div>`;
    modal.find('.modal-body').prepend(alertHtml);
}

// Search services
function searchServices() {
    const searchTerm = document.getElementById('searchInput').value;
    if (searchTerm.trim()) {
        window.location.href = `?search=${encodeURIComponent(searchTerm)}`;
    }
}

// Add Service Form Handler
document.getElementById('addServiceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const targetUrl = document.getElementById('targetUrl').value;
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    submitBtn.disabled = true;
    
    fetch('/ops/api/services/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            target_base_url: targetUrl
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast('Service created successfully!', 'success');
            $('#addServiceModal').modal('hide');
            resetModal('#addServiceModal');
            location.reload(); // Refresh page to show new service
        } else {
            showModalError('#addServiceModal', 'Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showModalError('#addServiceModal', 'Failed to create service: ' + error.message);
    })
    .finally(() => {
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Edit Service
function editService(uuid, targetUrl) {
    currentServiceUuid = uuid;
    document.getElementById('editServiceUuid').value = uuid;
    document.getElementById('editTargetUrl').value = targetUrl;
    resetModal('#editServiceModal');
    $('#editServiceModal').modal('show');
}

// Edit Service Form Handler
document.getElementById('editServiceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const targetUrl = document.getElementById('editTargetUrl').value;
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
    submitBtn.disabled = true;
    
    fetch(`/ops/api/services/${currentServiceUuid}/`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            target_base_url: targetUrl
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast('Service updated successfully!', 'success');
            $('#editServiceModal').modal('hide');
            resetModal('#editServiceModal');
            location.reload(); // Refresh page to show updated service
        } else {
            showModalError('#editServiceModal', 'Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showModalError('#editServiceModal', 'Error: ' + error.message);
    })
    .finally(() => {
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Delete Service
function deleteService(uuid, targetUrl) {
    currentServiceUuid = uuid;
    document.getElementById('deleteServiceUuid').textContent = uuid;
    document.getElementById('deleteServiceUrl').textContent = targetUrl;
    $('#deleteServiceModal').modal('show');
}

// Confirm Delete Handler
document.getElementById('confirmDelete').addEventListener('click', function() {
    // Show loading state
    const deleteBtn = this;
    const originalText = deleteBtn.innerHTML;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    deleteBtn.disabled = true;
    
    fetch(`/ops/api/services/${currentServiceUuid}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast('Service deleted successfully!', 'success');
            $('#deleteServiceModal').modal('hide');
            location.reload(); // Refresh page to show updated list
        } else {
            showToast('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to delete service: ' + error.message, 'error');
    })
    .finally(() => {
        // Reset button state
        deleteBtn.innerHTML = originalText;
        deleteBtn.disabled = false;
    });
});

// Get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Modal event handlers
$(document).ready(function() {
    // Reset modal when hidden
    $('#addServiceModal').on('hidden.bs.modal', function() {
        resetModal('#addServiceModal');
    });
    
    $('#editServiceModal').on('hidden.bs.modal', function() {
        resetModal('#editServiceModal');
    });
    
    // Clear current service UUID when modals are hidden
    $('#editServiceModal, #deleteServiceModal').on('hidden.bs.modal', function() {
        currentServiceUuid = null;
    });
    
    // Search on Enter key press
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchServices();
        }
    });
});

// Debug function for testing modal opening
function debugModal() {
    $('#addServiceModal').modal('show');
}

// Alternative way to open Add Service Modal
function openAddServiceModal() {
    $('#addServiceModal').modal('show');
}
function closeAddServiceModal() {
    $('#addServiceModal').modal('hide');
}
</script>
{% endblock %}
